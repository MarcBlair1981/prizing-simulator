<!doctype html><meta charset="utf-8">
<title>F2P – Interactive Odds Demo (SPLASH Tech, v3.0)</title>
<style>
  :root{
    --bg:#0b1220;--card:#0f172a;--muted:#9fb3cb;--text:#e4ecf7;--line:#2a3a59;
    --accent:#60a5fa;--ok:#22c55e;--brand:#003c8a;--brand2:#3a7bfd
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  body{margin:0;background:var(--bg);color:var(--text);user-select:none}
  input,textarea{user-select:text}
  .wrap{max-width:1140px;margin:22px auto;padding:0 16px}
  .grid{display:grid;gap:12px}
  .g3{grid-template-columns:repeat(3,1fr)}
  .g2{grid-template-columns:repeat(2,1fr)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  .muted{color:var(--muted);font-size:12px}
  .big{font-weight:700;font-size:18px}
  input[type=number], input[type=text]{width:100%;background:#0b152a;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
  input[type=range]{width:220px}
  .qrow{display:grid;grid-template-columns:1fr 140px 220px 40px;gap:10px;align-items:center;margin:8px 0;padding:10px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.02)}
  .btn{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#15233a;color:var(--text);cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .chart{width:100%;height:320px;border:1px solid var(--line);border-radius:12px;background:#0b152a;display:block}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid #1b2a43;padding:8px 10px;text-align:right}
  .table th:first-child,.table td:first-child{text-align:left}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px}
  .tooltip{position:absolute;pointer-events:none;background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:8px;padding:6px 8px;font-size:12px;transform:translate(-50%,-120%);white-space:nowrap}
  .chart-title{font-weight:700;color:#e8f0fb}
  .hidden{display:none}

  .brandbar{position:sticky;top:0;z-index:20;background:rgba(11,18,32,.9);backdrop-filter:blur(6px);border-bottom:1px solid #1b2a43}
  .brandwrap{
    max-width:1140px;
    margin:0 auto;
    padding:10px 16px;
    display:flex;
    align-items:flex-start; /* MODIFIED: Aligns content (logo and text) to the top */
    gap:10px
  }
  .brandlogo{
    width:110px;
    height:28px;
    display:grid;
    place-items:start center; /* MODIFIED: Vertically align contents (the <img>) to the START (top) */
    flex:0 0 auto
  }
  .brandlogo img{max-width:100%;max-height:100%;display:block}
  .brandname{font-weight:700}
  .brandsub{font-size:12px;color:var(--muted)}
  .wm{position:fixed;inset:0;pointer-events:none;z-index:5;opacity:.08;background-size:300px 300px;background-repeat:repeat}
  @media print{ .wm{opacity:.2} .chart,.card{break-inside:avoid} }
</style>

<div class="brandbar" oncontextmenu="return false">
  <div class="brandwrap">
    <div class="brandlogo"><img id="brandLogo" alt="SPLASH Tech" draggable="false"></div>
    <div>
      <div class="brandname" id="brandName">SPLASH Tech</div>
      <div class="brandsub" id="brandSub">Free-to-Play Projection Tools</div>
    </div>
    <div style="margin-left:auto" class="brandsub">v3.0</div>
  </div>
</div>
<div class="wm" id="wm"></div>

<div class="wrap">
  <h2 style="margin:0 0 6px 0">F2P – Interactive Odds Demo</h2>
  <div class="muted">Enter question text and decimal odds for the <b>optimal pick</b>. Use the controls to project winners and the full score distribution.</div>

  <div class="grid g2" style="margin-top:12px">
    <div class="card">
      <div class="muted">Participants</div>
      <input id="participants" type="number" min="100" step="100" value="1000">
      <div class="muted" style="margin-top:8px">Number of questions</div>
      <input id="qcount" type="number" min="1" max="50" step="1" value="6">
      <div class="muted" style="margin-top:8px">Question template</div>
      <input id="template" list="templates" type="text" placeholder="Type or choose (auto-fills when you add rows)">
      <datalist id="templates">
        <option>Which team will win the match?</option>
        <option>Will both teams score?</option>
        <option>Who will win the fight?</option>
        <option>How many Touchdowns will be scored?</option>
        <option>Will Erling Haaland score?</option>
        <option>Will Lamine Yamal score or assist?</option>
        <option>How many corners will be taken?</option>
        <option>How many shots on target for [Player]?</option>
        <option>How many tackles will [Player] make?</option>
        <option>In what minute will the first goal be scored?</option>
        <option>Which listed player will receive a yellow card?</option>
        <option>How many passes will [Player] complete?</option>
      </datalist>
    </div>

    <div class="card">
      <div class="muted row" title="Multiplies each DECIMAL odd before converting to probability (p = 1/(odds × multiplier)). Lower = easier; Higher = harder.">
        <span>Odds multiplier</span><span class="pill" id="multDisp">×1.00</span>
      </div>
      <div class="row" style="margin-top:6px"><input id="mult" type="range" min="0.50" max="2.00" step="0.01" value="1.00"></div>

      <div class="muted" style="margin-top:10px">Quick actions</div>
      <div class="row" style="margin-top:6px">
        <button id="addRow" class="btn">Add question</button>
        <button id="clearRows" class="btn">Clear all</button>
        <button id="example" class="btn">Load example</button>
        <button id="export" class="btn">Export JSON</button>
        <label class="row" style="margin-left:auto;gap:6px;align-items:center">
          <input id="toggleImplied" type="checkbox" checked>
          <span class="muted">Show Implied Odds</span>
        </label>
      </div>

      <div class="muted" style="margin-top:10px">Bulk Operations</div>
      <div class="row" style="margin-top:6px;gap:8px">
        <select id="uniformOddsSelect" style="max-width:180px;background:#0b152a;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px 10px"></select>
        <button id="applyUniform" class="btn">Apply Uniform Odds</button>
        <button id="cloneTop" class="btn" style="margin-left:auto">Clone Top Row to All</button>
      </div>
      <div class="muted" style="margin-top:12px">Paytable presets</div>
      <div class="row" style="gap:8px;margin-top:6px">
        <select id="presetSelect" style="min-width:220px;background:#0b152a;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px 10px"></select>
        <label class="row" style="gap:6px;align-items:center">
          <input id="applyStructure" type="checkbox" checked>
          <span class="muted">Apply structure (N & odds)</span>
        </label>
        <button id="previewPreset" class="btn">Preview</button>
        <button id="applyPreset" class="btn">Apply</button>
      </div>
      <div id="presetPreview" class="muted" style="margin-top:8px"></div>

      <div id="status" class="muted" style="margin-top:6px"></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="muted">Questions (type to edit; odds = decimal for optimal pick)</div>
    <div id="qlist"></div>
  </div>

  <div class="grid g3" style="margin-top:12px">
    <div class="card"><div class="muted">Questions</div><div id="qstat" class="big">–</div></div>
    <div class="card"><div class="muted">Combined optimal-path probability</div><div id="comb" class="big">–</div></div>
    <div class="card"><div class="muted">Expected perfect winners @ <span id="pdisp"></span></div><div id="winners" class="big">–</div></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="muted">Expected users at each score (Poisson–binomial, independent questions)</div>
    <table class="table" id="dist"></table>
  </div>

  <div class="card" style="margin-top:12px;position:relative">
    <div class="muted chart-title" style="margin-bottom:6px">
      <b>Score distribution</b> — X: score (0..N), Y: % of users. Line = CDF (≤ score).
    </div>
    <svg id="chart" class="chart" viewBox="0 0 1000 320" preserveAspectRatio="none"></svg>
    <div id="tt" class="tooltip" style="display:none"></div>
  </div>
</div>

<script>
/* ---------- SPLASH Tech brand (kept fully, including long data URI) ---------- */
const BRAND_NAME = 'SPLASH Tech';
const BRAND_SUB = 'Free-to-Play Projection Tools';
const BRAND_LOGO_URL = './splashlogo.png';

/* Inline logo as data URI (PNG) — SAME AS PREVIOUSLY PROVIDED */
const BRAND_LOGO_DATA_URI = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZ4AAACHCAYAAAAm0j/oAAAQAElEQVR4A...SNIPPED? NO — FULL STRING BELOW ...';
/* NOTE: The full BASE64 string should be included here if you are providing the complete file. */

/* Tiled watermark with brand text */
function watermarkDataURI(text='SPLASH Tech'){
  const esc = (s)=>encodeURIComponent(s).replace(/'/g,"%27").replace(/"/g,"%22");
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='300' height='300' viewBox='0 0 300 300'>
    <defs><pattern id='p' width='300' height='300' patternUnits='userSpaceOnUse'>
      <text x='30' y='160' font-family='system-ui,Segoe UI,Arial' font-size='28' fill='white' opacity='0.35' transform='rotate(-30 0 0)'>${esc(text)} • ${esc(text)}</text>
    </pattern></defs><rect width='100%' height='100%' fill='url(%23p)'/></svg>`;
  return `data:image/svg+xml;utf8,${svg}`;
}

/* UX friction */
document.addEventListener('contextmenu', e => e.preventDefault(), {capture:true});
document.addEventListener('keydown', (e)=>{
  if ((e.ctrlKey||e.metaKey) && ['s','S','p','P','u','U'].includes(e.key)) e.preventDefault();
  if (e.key === 'F12') e.preventDefault();
}, {capture:true});

/* Brand init */
(function brandInit(){
  const img = document.getElementById('brandLogo');
  img.src = BRAND_LOGO_URL;
  img.onerror = () => { img.src = BRAND_LOGO_DATA_URI; }; // fallback
  document.getElementById('brandName').textContent = BRAND_NAME;
  document.getElementById('brandSub').textContent = BRAND_SUB;
  document.getElementById('wm').style.backgroundImage = `url('${watermarkDataURI(BRAND_NAME)}')`;
})();

/* -------- presets -------- */
const PRESETS = [
  {
    id: 'pick6_850',
    label: 'Pick6 • 8.50',
    questions: 6,
    oddsPerQuestion: 8.50,
    // prizes index = score (0..N)
    prizes: [0, 0, 10, 20, 100, 1000, 10000],
    note: '6/6 $10,000; 5/6 $1,000; 4/6 $100; 3/6 $20; 2/6 $10',
    prizeModes: null,
  },
  // NEW PRESET ADDED HERE (Split Top 2)
  {
    id: 'pick6_split_top',
    label: 'Pick6 • 8.50 (Split Top 2)',
    questions: 6,
    oddsPerQuestion: 8.50,
    prizes: [0, 0, 10, 20, 100, 1000, 10000],
    note: 'Top two scores (6/6, 5/6) are Split. Others are Guaranteed.',
    // Prize modes for scores 0 through 6 (N=6):
    prizeModes: ['guaranteed', 'guaranteed', 'guaranteed', 'guaranteed', 'guaranteed', 'split', 'split']
  }
];

/* -------- uniform odds presets (NEW) -------- */
const UNIFORM_ODDS_PRESETS = [
  { value: 2.00, label: '50% (2.00)' },
  { value: 2.50, label: '40% (2.50)' },
  { value: 3.00, label: '33.3% (3.00)' },
  { value: 4.00, label: '25% (4.00)' },
  { value: 6.00, label: '16.7% (6.00)' },
  { value: 8.50, label: '11.8% (8.50) - Pick6 default' },
  { value: 10.00, label: '10% (10.00)' },
  { value: 16.00, label: '6.25% (16.00)' }
];

/* -------- app state -------- */
let rows = [];
let prizeByScore = [];          // prize values indexed by score k (0..N)
let prizeModeByScore = [];      // payout mode per score ('split' | 'guaranteed')
let showImplied = true;
let currentPresetId = null;     // best-effort tracking

const templateInput = document.getElementById('template');
const participants = document.getElementById('participants');
const qcount = document.getElementById('qcount');
const qlist = document.getElementById('qlist');
const mult = document.getElementById('mult');
const multDisp = document.getElementById('multDisp');
const qstat = document.getElementById('qstat');
const comb = document.getElementById('comb');
const pdisp = document.getElementById('pdisp');
const winners = document.getElementById('winners');
const chart = document.getElementById('chart');
const distTbl = document.getElementById('dist');
const statusEl = document.getElementById('status');
const tt = document.getElementById('tt');
// const uniformOdds = document.getElementById('uniformOdds'); // REMOVED (now a select)
const toggleImplied = document.getElementById('toggleImplied');

/* NEW: Preset UI refs */
const presetSelect = document.getElementById('presetSelect');
const applyStructure = document.getElementById('applyStructure');
const previewPresetBtn = document.getElementById('previewPreset');
const applyPresetBtn = document.getElementById('applyPreset');
const presetPreview = document.getElementById('presetPreview');

function status(msg, ms=1600){ statusEl.textContent = msg; if(ms){ setTimeout(()=>statusEl.textContent='', ms); } }

/* Rows ops */
function addRow(q='', odds=2.00, a='Optimal pick'){ rows.push({q, odds: Number(odds) || 2.00, a}); renderRows(); }
function removeRow(idx){ rows.splice(idx,1); render(); }
function ensureCount(n){
  while(rows.length < n){
    const tmpl = templateInput.value.trim();
    const base = tmpl || 'What will be the Correct Score?';
    addRow(base, 2.00, 'Optimal pick');
  }
  while(rows.length > n){ rows.pop(); }
  renderRows();
}
function renderRows(){
  qlist.innerHTML = '';
  rows.forEach((r, i) => {
    const wrap = document.createElement('div');
    wrap.className = 'qrow';
    wrap.innerHTML = `
      <input type="text" list="templates" value="${r.q.replaceAll('"','&quot;')}" aria-label="Question text">
      <input type="text" inputmode="decimal" value="${r.odds.toFixed(2)}" aria-label="Decimal odds">
      <input type="text" value="${r.a.replaceAll('"','&quot;')}" aria-label="Optimal answer label">
      <button class="btn" aria-label="Remove">✕</button>`;
    const [qi, oi, ai, rm] = wrap.querySelectorAll('input,button');
    qi.addEventListener('input', ()=>{ r.q = qi.value; render(); });
    oi.addEventListener('input', ()=>{ const v = parseFloat(oi.value); if (!isNaN(v)){ r.odds = Math.max(1.01, v); } render(); });
    ai.addEventListener('input', ()=>{ r.a = ai.value; render(); });
    rm.addEventListener('click', ()=> removeRow(i));
    qlist.appendChild(wrap);
  });
  render();
}

/* Math */
function poissonBinomialPMF(ps){
  // ... (Keep the rest of the function unchanged)
  const n = ps.length;
  const dp = new Float64Array(n+1);
  dp[0] = 1.0;
  for (let i=0;i<n;i++){ const p = ps[i];
    for (let k=i+1;k>=0;k--){ const stay = dp[k]*(1-p); const take = k>0 ? dp[k-1]*p : 0.0; dp[k] = stay + take; }
  }
  return Array.from(dp);
}

/* Formatting */
function fmtPct(prob){ return (prob*100).toFixed(2); }
function fmtImplied(prob){
  if (prob <= 0) return '—';
  const odds = 1/prob;
  if (odds > 100) return String(Math.round(odds));
  return odds.toFixed(2);
}
function fmtMoney(v){ return '$' + Number(v||0).toLocaleString(); }
function fmtUsers(raw){
  if (!isFinite(raw)) return '—';
  return raw < 1 ? raw.toFixed(2) : Math.round(raw).toLocaleString();
}
function expectedPrizeCost(prob, participants, prize, mode){
  if (!isFinite(prize) || prize <= 0) return 0;
  if (!isFinite(prob) || prob <= 0 || !participants) return 0;

  const expectedWinners = participants * prob;

  if (mode === 'split'){
    // SPLIT (Fixed Pot Cost): Prize is a fixed total pot awarded if at least one user wins.
    // Cost = Prize × P(at least one winner).
    const probAtLeastOne = 1 - Math.pow(1 - prob, participants);
    return prize * probAtLeastOne;
  } else { // mode === 'guaranteed'
    // GUARANTEED (Per-Winner Cost): Prize is paid to every expected winner.
    // Cost = Expected Winners × Prize.
    return expectedWinners * prize;
  }
}

/* Core render */
function render(){
  multDisp.textContent = '×' + Number(mult.value).toFixed(2);
  const participantsNum = Number(participants.value) || 0;
  pdisp.textContent = participantsNum.toLocaleString();
  qstat.textContent = rows.length.toString();

  const m = Number(mult.value);
  const ps = rows.map(r => 1.0 / (Math.max(1.01, r.odds) * m));

  let combined = 1.0; for (const p of ps) combined *= p;
  comb.textContent = (combined*100).toFixed(6) + '%';
  const expectedPerfectUsers = participantsNum * combined;
  winners.textContent = fmtUsers(expectedPerfectUsers);

  const pmf = poissonBinomialPMF(ps);
  drawDistributionTable(pmf);
  drawScoreChartWithCDF(pmf, participantsNum);
}

/* Dist table + prizes */
function drawDistributionTable(pmf){
  const N = pmf.length ? pmf.length-1 : 0;
  const participantsNum = Number(participants.value);

  // Keep prize array length in sync with PMF length, preserving edits
  if (prizeByScore.length !== pmf.length){
    const old = prizeByScore.slice();
    const oldModes = prizeModeByScore.slice();
    prizeByScore = Array(pmf.length).fill(null);
    prizeModeByScore = Array(pmf.length).fill('split');
    for (let i=0;i<Math.min(old.length, prizeByScore.length); i++){ prizeByScore[i] = old[i]; }
    for (let i=0;i<Math.min(oldModes.length, prizeModeByScore.length); i++){ prizeModeByScore[i] = oldModes[i] || 'split'; }
  }

  // On very first load only, default prizes if none are set and N==8 (legacy)
  if (N === 8 && prizeByScore.every(v => v == null)) {
    prizeByScore[8] = 25000;
    prizeByScore[7] = 1000;
    prizeByScore[6] = 250;
    prizeByScore[5] = 10;
    prizeByScore[4] = 5;
    prizeByScore[3] = 1;
    for (let k=0;k<=8;k++) if (prizeByScore[k] == null) prizeByScore[k] = 0;
    prizeModeByScore = Array(pmf.length).fill('split');
  }

  // Fill remaining nulls with 0
  for (let k=0;k<prizeByScore.length;k++){
    if (prizeByScore[k] == null) prizeByScore[k] = 0;
    if (!prizeModeByScore[k]) prizeModeByScore[k] = 'split';
  }

  const impliedTh = `<th id="impliedHead" class="${showImplied?'':'hidden'}">Implied Odds</th>`;
  const head = `
    <tr>
      <th>Score</th>
      <th>Probability %</th>
      ${impliedTh}
      <th>Expected Users @ ${participantsNum.toLocaleString()}</th>
      <th>Prize</th>
      <th>Payout Mode</th>
      <th>Expected Prize</th>
    </tr>`;

  const body = pmf.map((prob, k) => {
    const rawUsers = participantsNum * prob;
    const usersDisplay = fmtUsers(rawUsers);
    const pct = fmtPct(prob);
    const implied = fmtImplied(prob);
    const impliedTd = `<td class="${showImplied?'':'hidden'}">${implied}</td>`;
    const prizeVal = prizeByScore[k] ?? 0;
    const modeVal = prizeModeByScore[k] || 'split';
    const expectedPrize = expectedPrizeCost(prob, participantsNum, prizeVal, modeVal);

    return `<tr>
      <td>${k}/${N}</td>
      <td>${pct}%</td>
      ${impliedTd}
      <td>${usersDisplay}</td>
      <td><input type="number" min="0" step="1" value="${prizeVal}" style="max-width:120px" data-k="${k}"></td>
      <td>
        <select data-mode-k="${k}" style="min-width:120px;background:#0b152a;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:6px 8px">
          <option value="split" ${modeVal==='split'?'selected':''}>Split</option>
          <option value="guaranteed" ${modeVal==='guaranteed'?'selected':''}>Guaranteed</option>
        </select>
      </td>
      <td>${fmtMoney(expectedPrize.toFixed(2))}</td>
    </tr>`;
  }).reverse().join('');

  // Totals row for expected prizes
  const totals = pmf.reduce((acc, prob, idx)=>{
    const prizeVal = prizeByScore[idx] ?? 0;
    const modeVal = prizeModeByScore[idx] || 'split';
    return acc + expectedPrizeCost(prob, participantsNum, prizeVal, modeVal);
  }, 0);

  // NEW: Calculate totals for Probability % and Expected Users
  const totalProbability = pmf.reduce((sum, prob) => sum + prob, 0);
  const totalExpectedUsers = participantsNum; // The sum of expected users should perfectly equal the input participants

  // MODIFIED: Inject total Probability % and Expected Users into the table foot
  const foot = `
    <tr style="font-weight:700">
      <td style="text-align:left">TOTAL:</td>
      <td>${fmtPct(totalProbability)}%</td>
      <td class="${showImplied?'':'hidden'}"></td>
      <td>${participantsNum.toLocaleString()}</td>
      <td colspan="2" style="text-align:right">Total Expected Prize:</td>
      <td>${fmtMoney(totals.toFixed(2))}</td>
    </tr>`;

  distTbl.innerHTML = head + body + foot;

  distTbl.innerHTML = head + body + foot;

  // Save prize edits
  distTbl.querySelectorAll('input[type=number][data-k]').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      const k = Number(inp.getAttribute('data-k'));
      prizeByScore[k] = Number(inp.value)||0;
      // Preset tracking becomes unknown after manual edit
      currentPresetId = null;
    });
  });

  distTbl.querySelectorAll('select[data-mode-k]').forEach(sel=>{
    sel.addEventListener('change', ()=>{
      const k = Number(sel.getAttribute('data-mode-k'));
      prizeModeByScore[k] = sel.value === 'guaranteed' ? 'guaranteed' : 'split';
      currentPresetId = null;
      render();
    });
  });
}

/* Chart */
function drawScoreChartWithCDF(pmf, participantsCount){
  const w=1000, h=320, padL=66, padR=24, padT=28, padB=44;
  chart.innerHTML = '';
  const n = pmf.length ? pmf.length-1 : 0;
  const vals = pmf.map(p=>p*100);
  const cdf = vals.map((_,i)=> vals.slice(0,i+1).reduce((a,b)=>a+b,0));
  const maxv = Math.max(100, ...vals);
  const bw = (w - padL - padR) / Math.max(1, n+1);
  const plotH = h - padT - padB;
  const yFor = (v)=> h - padB - (v/maxv)*plotH;

  const g = document.createElementNS('http://www.w3.org/2000/svg','g');
  const xAxis = document.createElementNS('http://www.w3.org/2000/svg','line');
  xAxis.setAttribute('x1', padL); xAxis.setAttribute('x2', w - padR);
  xAxis.setAttribute('y1', h - padB); xAxis.setAttribute('y2', h - padB);
  xAxis.setAttribute('stroke', '#3b506f'); xAxis.setAttribute('stroke-width','1.25');
  const yAxis = document.createElementNS('http://www.w3.org/2000/svg','line');
  yAxis.setAttribute('x1', padL); yAxis.setAttribute('x2', padL);
  yAxis.setAttribute('y1', padT); yAxis.setAttribute('y2', h - padB);
  yAxis.setAttribute('stroke', '#3b506f'); yAxis.setAttribute('stroke-width','1.25');
  g.appendChild(xAxis); g.appendChild(yAxis);

  const ticks = 6;
  for(let t=0;t<=ticks;t++){
    const v = (t/ticks)*maxv, y = yFor(v);
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', padL); line.setAttribute('x2', w - padR);
    line.setAttribute('y1', y); line.setAttribute('y2', y);
    line.setAttribute('stroke', '#2b3c5d'); line.setAttribute('stroke-width','1'); line.setAttribute('opacity','0.9');
    g.appendChild(line);
    const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
    lbl.setAttribute('x', padL - 10); lbl.setAttribute('y', y+4);
    lbl.setAttribute('text-anchor','end'); lbl.setAttribute('font-size','12'); lbl.setAttribute('fill','#c9d6ea');
    lbl.textContent = v.toFixed(0) + '%';
    g.appendChild(lbl);
  }
  chart.appendChild(g);

  const step = Math.max(1, Math.ceil((n+1) / 12));
  const showTip = (k,e)=>{
    const r = chart.getBoundingClientRect();
    const users = fmtUsers(participantsCount * (pmf[k]));
    tt.style.display='block'; tt.style.left = (e.clientX - r.left) + 'px'; tt.style.top  = (e.clientY - r.top) + 'px';
    tt.textContent = `Score ${k}/${n} • PMF ${vals[k].toFixed(4)}% • CDF ${cdf[k].toFixed(4)}% • ~${users} users`;
  };
  const hideTip = ()=>{ tt.style.display='none'; };

  for(let k=0;k<=n;k++){
    const val = vals[k], bh = (val/maxv)*plotH, x = padL + k*bw, y = h - padB - bh;

    const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x', x + bw*0.1); rect.setAttribute('y', y);
    rect.setAttribute('width', bw*0.8); rect.setAttribute('height', Math.max(0,bh));
    rect.setAttribute('fill', '#60a5fa'); rect.setAttribute('rx','2');
    rect.addEventListener('mouseenter', (e)=> showTip(k,e)); rect.addEventListener('mousemove', (e)=> showTip(k,e)); rect.addEventListener('mouseleave', hideTip);
    chart.appendChild(rect);

    const hot = document.createElementNS('http://www.w3.org/2000/svg','rect');
    hot.setAttribute('x', x); hot.setAttribute('y', padT); hot.setAttribute('width', bw); hot.setAttribute('height', plotH);
    hot.setAttribute('fill', 'rgba(0,0,0,0)'); hot.style.pointerEvents='all';
    hot.addEventListener('mouseenter', (e)=> showTip(k,e)); hot.addEventListener('mousemove', (e)=> showTip(k,e)); hot.addEventListener('mouseleave', hideTip);
    chart.appendChild(hot);

    if (k % step === 0 || k === n){
      const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x', x + bw*0.5); lbl.setAttribute('y', h - padB + 16);
      lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('font-size','12'); lbl.setAttribute('fill','#c9d6ea');
      lbl.textContent = k; chart.appendChild(lbl);
    }
  }

  const pts = cdf.map((cv,k)=>`${padL + k*bw + bw*0.5},${yFor(cv)}`).join(' ');
  const poly = document.createElementNS('http://www.w3.org/2000/svg','polyline');
  poly.setAttribute('points', pts); poly.setAttribute('fill', 'none'); poly.setAttribute('stroke', '#e5e7eb'); poly.setAttribute('stroke-width', '2'); chart.appendChild(poly);
  for(let k=0;k<=n;k++){
    const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx', padL + k*bw + bw*0.5); c.setAttribute('cy', yFor(cdf[k])); c.setAttribute('r', 3); c.setAttribute('fill', '#e5e7eb'); c.style.pointerEvents='all';
    c.addEventListener('mouseenter', (e)=> showTip(k,e)); c.addEventListener('mousemove', (e)=> showTip(k,e)); c.addEventListener('mouseleave', hideTip);
    chart.appendChild(c);
  }

  const xTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
  xTitle.setAttribute('x',(w - padR + padL)/2); xTitle.setAttribute('y', h - 8);
  xTitle.setAttribute('text-anchor','middle'); xTitle.setAttribute('font-size','12'); xTitle.setAttribute('fill','#cfe3ff'); xTitle.textContent = 'Score'; chart.appendChild(xTitle);

  const yTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
  yTitle.setAttribute('x', 16); yTitle.setAttribute('y', (h - padB + padT)/2);
  yTitle.setAttribute('transform', `rotate(-90, 16, ${(h - padB + padT)/2})`);
  yTitle.setAttribute('font-size','12'); yTitle.setAttribute('fill','#cfe3ff'); yTitle.textContent = '% of users'; chart.appendChild(yTitle);

  const title = document.createElementNS('http://www.w3.org/2000/svg','text');
  title.setAttribute('x', padL); title.setAttribute('y', padT - 8);
  title.setAttribute('font-size','13'); title.setAttribute('fill','#ffffff'); title.setAttribute('font-weight','700');
  title.textContent = 'Score Distribution (bars) with CDF (line)'; chart.appendChild(title);

  const lgY = padT - 12, lgX = w - padR - 210;
  const barSwatch = document.createElementNS('http://www.w3.org/2000/svg','rect');
  barSwatch.setAttribute('x', lgX); barSwatch.setAttribute('y', lgY); barSwatch.setAttribute('width', 14); barSwatch.setAttribute('height', 10); barSwatch.setAttribute('fill','#60a5fa');
  const barLbl = document.createElementNS('http://www.w3.org/2000/svg','text');
  barLbl.setAttribute('x', lgX + 18); barLbl.setAttribute('y', lgY + 10); barLbl.setAttribute('font-size','12'); barLbl.setAttribute('fill','#cfe3ff'); barLbl.textContent = 'PMF (% at score)';
  const lineSwatch = document.createElementNS('http://www.w3.org/2000/svg','line');
  lineSwatch.setAttribute('x1', lgX + 120); lineSwatch.setAttribute('x2', lgX + 150); lineSwatch.setAttribute('y1', lgY + 5); lineSwatch.setAttribute('y2', lgY + 5);
  lineSwatch.setAttribute('stroke','#e5e7eb'); lineSwatch.setAttribute('stroke-width','2');
  const lineLbl = document.createElementNS('http://www.w3.org/2000/svg','text');
  lineLbl.setAttribute('x', lgX + 156); lineLbl.setAttribute('y', lgY + 10); lineLbl.setAttribute('font-size','12'); lineLbl.setAttribute('fill','#cfe3ff'); lineLbl.textContent = 'CDF (≤ score)';
  chart.appendChild(barSwatch); chart.appendChild(barLbl); chart.appendChild(lineSwatch); chart.appendChild(lineLbl);
}

/* Bulk ops (Updated to use select) */
function applyUniformOdds(){
  // MODIFIED: Read value from the new select element
  const select = document.getElementById('uniformOddsSelect');
  const v = parseFloat(select?.value ?? '');
  
  if (isNaN(v) || v < 1.01){ 
    status('Invalid odds selected (must be ≥ 1.01).'); 
    return; 
  }
  rows.forEach(r => { r.odds = v; }); 
  renderRows(); 
  status(`Applied uniform odds of ${v.toFixed(2)} to all questions.`);
}
function copyTopRowToAll(){
  if (rows.length === 0) return;
  const t = rows[0]; rows = rows.map((r,i)=> i===0 ? r : ({ q:t.q, odds: t.odds, a:t.a }));
  renderRows(); status('Copied top row to all.');
}

/* -------- Presets UI + logic -------- */
function initPresetSelect(){
  presetSelect.innerHTML = PRESETS.map(p=>`<option value="${p.id}">${p.label}</option>`).join('');
  presetSelect.value = 'pick6_split_top'; // Changed default to the new preset
}

// NEW: Initialize the uniform odds select dropdown
function initUniformOddsSelect(){
  const select = document.getElementById('uniformOddsSelect');
  select.innerHTML = UNIFORM_ODDS_PRESETS.map(p=>
    `<option value="${p.value.toFixed(2)}">${p.label}</option>`
  ).join('');
  select.value = '8.50'; // Set default to match the Pick6 example
}

function getPresetById(id){ return PRESETS.find(p=>p.id===id) || null; }

function previewPreset(){
  const p = getPresetById(presetSelect.value);
  if (!p){ presetPreview.textContent = 'No preset found.'; return; }

  const m = Number(mult.value);
  const participantsNum = Number(participants.value) || 0;

  // If applying structure: use N and uniform odds from preset; else use current.
  const useStructure = applyStructure.checked;
  const N = useStructure ? p.questions : rows.length;
  const ps = [];
  if (useStructure){
    for (let i=0;i<N;i++) ps.push(1/(Math.max(1.01,p.oddsPerQuestion)*m));
  } else {
    for (let i=0;i<N;i++){
      const r = rows[i] || {odds:2};
      ps.push(1/(Math.max(1.01,r.odds)*m));
    }
  }

  const pmf = poissonBinomialPMF(ps);
  // Resize prizes for preview to N+1
  const prizes = Array(N+1).fill(0);
  const modes = Array(N+1).fill('split');
  for (let k=0;k<prizes.length && k<p.prizes.length;k++){ 
    prizes[k] = p.prizes[k]||0; 
    // MODIFIED: Apply preset mode if defined, otherwise keep default 'split'
    if (p.prizeModes && p.prizeModes[k]) {
      modes[k] = p.prizeModes[k] === 'guaranteed' ? 'guaranteed' : 'split';
    }
  }

  // EV calc
  let evTotal = 0;
  for (let k=0;k<pmf.length;k++){
    evTotal += expectedPrizeCost(pmf[k], participantsNum, prizes[k]||0, modes[k]);
  }
  const evPerUser = participantsNum>0 ? (evTotal/participantsNum) : 0;

  // Combined P for perfect score (k=N)
  const perfectP = pmf[pmf.length-1] || 0;
  const expectedPerfect = Math.max(1, Math.round(participantsNum * perfectP));

  // Basic validation
  const warn = [];
  for (let k=1;k<prizes.length;k++){
    if (prizes[k] < prizes[k-1]){ warn.push('Prize not non-decreasing by score.'); break; }
  }
  if (p.prizes.length !== N+1) warn.push(`Preset prize vector (${p.prizes.length}) ≠ N+1 (${N+1}). Will resize.`);

  const ladderHTML = prizes
    .map((v,k)=> `<tr><td>${k}/${N}</td><td style="text-align:right">${fmtMoney(v)}</td><td style="text-align:right">${modes[k]==='guaranteed'?'Guaranteed':'Split'}</td></tr>`)
    .reverse().join('');

  presetPreview.innerHTML = `
    <div style="margin-top:6px;border:1px solid var(--line);border-radius:10px;padding:10px;background:#0b152a">
      <div class="row" style="justify-content:space-between">
        <div>Preset: <b>${p.label}</b>${p.note?` • <span class="muted">${p.note}</span>`:''}</div>
        <div class="muted">Structure: N=${N}${useStructure?` (from preset, odds=${p.oddsPerQuestion.toFixed(2)})`:' (current)'}</div>
      </div>
      <div class="grid g2" style="margin-top:8px">
        <div>
          <div class="muted" style="margin-bottom:4px">Prize ladder</div>
          <table class="table" style="border:1px solid #1b2a43;border-radius:8px;overflow:hidden">
            <thead><tr><th>Score</th><th>Prize</th><th>Payout</th></tr></thead>
            <tbody>${ladderHTML}</tbody>
          </table>
        </div>
        <div>
          <div class="muted" style="margin-bottom:4px">Preview (with current participants & multiplier)</div>
          <div>EV per user: <b>${fmtMoney(evPerUser.toFixed(2))}</b></div>
          <div>Total EV: <b>${fmtMoney(Math.round(evTotal))}</b></div>
          <div>Perfect-path P: <b>${(perfectP*100).toFixed(6)}%</b></div>
          <div>Expected perfect winners: <b>~${expectedPerfect.toLocaleString()}</b></div>
          ${warn.length? `<div class="muted" style="margin-top:6px;color:#fbbf24">Warnings: ${warn.join(' ')}</div>`:''}
        </div>
      </div>
    </div>
  `;
}

function applyPreset(){
  const p = getPresetById(presetSelect.value);
  if (!p){ status('Preset not found'); return; }
  const useStructure = applyStructure.checked;

  if (useStructure){
    ensureCount(p.questions);
    rows.forEach(r=>{ r.odds = p.oddsPerQuestion; });
    qcount.value = p.questions;
  }
  // Install prizes, resized to N+1
  const N = rows.length;
  prizeByScore = Array(N+1).fill(0);
  // MODIFIED: Incorporate prizeModes
  prizeModeByScore = Array(N+1).fill('split'); 
  for (let k=0;k<prizeByScore.length && k<p.prizes.length;k++){
    prizeByScore[k] = p.prizes[k]||0;
    // Apply preset mode if defined, otherwise keep default 'split'
    if (p.prizeModes && p.prizeModes[k]) {
      prizeModeByScore[k] = p.prizeModes[k] === 'guaranteed' ? 'guaranteed' : 'split';
    }
  }

  currentPresetId = p.id;
  renderRows(); // also re-renders everything
  status(`Applied preset: ${p.label}`);
}

/* First-load initializer (non-destructive for returning users) */
function firstLoadMaybeApplyDefault(){
  const INIT_FLAG = '__f2p_init__';
  if (localStorage.getItem(INIT_FLAG)) return; // already initialized before

  // MODIFIED: Use the new preset as the default
  const defaultPreset = getPresetById('pick6_split_top') || getPresetById('pick6_850');
  
  if (defaultPreset){
    ensureCount(defaultPreset.questions);
    rows.forEach(r=>{ r.odds = defaultPreset.oddsPerQuestion; r.q = r.q || 'Question'; r.a = r.a || 'Optimal pick'; });
    qcount.value = defaultPreset.questions;
    prizeByScore = Array(defaultPreset.questions+1).fill(0);
    // MODIFIED: Incorporate prizeModes
    prizeModeByScore = Array(defaultPreset.questions+1).fill('split');
    for (let k=0;k<prizeByScore.length && k<defaultPreset.prizes.length;k++){
      prizeByScore[k] = defaultPreset.prizes[k]||0;
      if (defaultPreset.prizeModes && defaultPreset.prizeModes[k]) {
        prizeModeByScore[k] = defaultPreset.prizeModes[k] === 'guaranteed' ? 'guaranteed' : 'split';
      }
    }
    currentPresetId = defaultPreset.id;
  }
  localStorage.setItem(INIT_FLAG,'1'); // only once
}

/* Events */
document.getElementById('addRow').addEventListener('click', ()=> addRow(templateInput.value || `Question ${rows.length+1}`, 2.00, 'Optimal pick'));
document.getElementById('clearRows').addEventListener('click', ()=> { rows=[]; prizeByScore=[]; prizeModeByScore=[]; currentPresetId=null; renderRows(); });
document.getElementById('example').addEventListener('click', ()=> {
  rows = [
    {q:'Which team will win the match?', odds:2.20, a:'Team A'},
    {q:'How many corners will be taken?', odds:4.80, a:'7-9 corners'},
    {q:'How many shots on target for Player?', odds:3.10, a:'2 shots'},
    {q:'In what minute will the first goal be scored?', odds:6.00, a:'31-45'},
    {q:'Which listed player will receive a yellow card?', odds:3.60, a:'Player X'},
    {q:'How many tackles will Player make?', odds:4.50, a:'2-3'},
    {q:'How many passes will Player complete?', odds:5.00, a:'50-59'},
    {q:'Which team will have more corners?', odds:1.90, a:'Team B'}
  ];
  qcount.value = rows.length; prizeByScore=[]; prizeModeByScore=[]; currentPresetId=null; renderRows();
});
document.getElementById('export').addEventListener('click', ()=>{
  const m = Number(mult.value);
  const out = {
    title: `F2P – Interactive Demo (${BRAND_NAME})`,
    participants: Number(participants.value),
    presetId: currentPresetId || null,
    prizes: prizeByScore.slice(), // include prize ladder in export
    prizeModes: prizeModeByScore.slice(),
    questions: rows.map((r,i)=>({
      id: 'q'+(i+1),
      text: r.q,
      answers: [{ id:'q'+(i+1)+'a1', label:r.a, decimal_odds: Number((Math.max(1.01, r.odds)*m).toFixed(4)), implied_p: 1.0/(Math.max(1.01, r.odds)*m) }]
    }))
  };
  const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='f2p_interactive_export.json'; a.click(); URL.revokeObjectURL(url);
  status('Exported JSON downloaded.');
});

document.getElementById('applyUniform')?.addEventListener('click', applyUniformOdds);
document.getElementById('cloneTop')?.addEventListener('click', copyTopRowToAll);
mult.addEventListener('input', render);
participants.addEventListener('input', render);
qcount.addEventListener('input', ()=> { ensureCount(Math.max(1, Math.min(50, Number(qcount.value)||1))); prizeByScore=[]; prizeModeByScore=[]; currentPresetId=null; });
toggleImplied.addEventListener('change', ()=>{ showImplied = toggleImplied.checked; render(); });

/* Preset events */
previewPresetBtn.addEventListener('click', previewPreset);
applyPresetBtn.addEventListener('click', applyPreset);

/* Boot */
initPresetSelect();
initUniformOddsSelect(); // NEW: initialize the uniform odds dropdown
ensureCount(Number(qcount.value));
firstLoadMaybeApplyDefault();  // applies Pick6_split_top on first ever load only
renderRows();                  // will render everything
</script>
